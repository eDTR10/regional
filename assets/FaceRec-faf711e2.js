import{p as ue,X as O,Y as P,Z as fe,_ as me,$ as X,a0 as he,a1 as ge,a2 as pe,a3 as xe,a4 as G,a5 as be,r as n,S as C,a6 as F,a7 as ye,a8 as ve,a as K,j as a,O as Z,a9 as we,aa as Se}from"./index-15a16bad.js";const je=ue("RotateCcw",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]]);function Ne(s,f){var l=Array.isArray(f)?f:[f];l.forEach(function(o){var c=o instanceof O?o.score:P(o)?o.detection.score:void 0,u=o instanceof O?o.box:P(o)?o.detection.box:new fe(o),x=c?""+me(c):void 0;new X(u,{label:x}).draw(s)})}function Fe(s,f,l){l===void 0&&(l=!1);var o=l?he(f):f,c=o.width,u=o.height;return s.width=c,s.height=u,{width:c,height:u}}function Q(s,f){var l=new ge(f.width,f.height),o=l.width,c=l.height;if(o<=0||c<=0)throw new Error("resizeResults - invalid dimensions: "+JSON.stringify({width:o,height:c}));if(Array.isArray(s))return s.map(function(v){return Q(v,{width:o,height:c})});if(pe(s)){var u=s.detection.forSize(o,c),x=s.unshiftedLandmarks.forSize(u.box.width,u.box.height);return xe(G(s,u),x)}return P(s)?G(s,s.detection.forSize(o,c)):s instanceof be||s instanceof O?s.forSize(o,c):s}function ke(s,f,l,o){const u=(l-s)*Math.PI/180,x=(o-f)*Math.PI/180,v=Math.sin(u/2)*Math.sin(u/2)+Math.cos(s*Math.PI/180)*Math.cos(l*Math.PI/180)*Math.sin(x/2)*Math.sin(x/2);return 6371*(2*Math.atan2(Math.sqrt(v),Math.sqrt(1-v)))}function Me(s,f,l,o,c=1.5){const u=ke(s,f,l,o);return{isNearby:u<=c,distance:u}}function Ee(s){return s.happy>.7}function De(){var W;const[s,f]=n.useState(!1),[l,o]=n.useState(!1),[c,u]=n.useState([]),v=(W=n.useRef((()=>{const e=localStorage.getItem("user");return e?JSON.parse(e):null})()).current)==null?void 0:W.full_name,[T,w]=n.useState(null),[ee,b]=n.useState(null),[D,k]=n.useState("pending"),[te,M]=n.useState("Please blink or smile to verify liveliness"),[A,y]=n.useState("Loading..."),j="/regional/models",m=n.useRef(null),g=n.useRef(null),[E,se]=n.useState("environment"),[z,B]=n.useState([]),[ne,ae]=n.useState([{id:"",name:"",position:""}]),_=n.useRef(),N=n.useRef(),I=n.useRef(null),$=n.useCallback(e=>{if(!e||e.length===0)return null;const[t]=e,[r,i]=t.split(",").map(Number);return{latitude:parseFloat(r.toFixed(6)),longitude:parseFloat(i.toFixed(6))}},[]),U=n.useCallback((e,t)=>{if(!navigator.geolocation){b(null),C.fire({icon:"error",title:"Geolocation Not Supported",text:"Your browser does not support geolocation.",confirmButtonColor:"#3085d6"});return}navigator.geolocation.getCurrentPosition(r=>{const{latitude:i,longitude:d}=r.coords,{isNearby:h,distance:p}=Me(i,d,e,t);h?(b(`✅ Within office range! (${p.toFixed(2)} km)`),w("ok")):(b(`❌ Outside office range (${p.toFixed(2)} km from office)`),w(!1))},r=>{b(null);const d={[r.PERMISSION_DENIED]:"Please enable location access in your browser settings. Or browse to you destop settings and enable location access.",[r.POSITION_UNAVAILABLE]:"Location information is unavailable.",[r.TIMEOUT]:"Location request timed out."}[r.code]||"An unknown error occurred.";C.fire({icon:"error",title:"Location Error",text:d,confirmButtonColor:"#3085d6"})})},[]),q=n.useCallback(async()=>{if(!l)try{y("Loading models..."),await Promise.all([F.ssdMobilenetv1.loadFromUri(j),F.tinyFaceDetector.loadFromUri(j),F.faceLandmark68Net.loadFromUri(j),F.faceRecognitionNet.loadFromUri(j),F.faceExpressionNet.loadFromUri(j)]),o(!0),console.log("Face models loaded successfully"),s&&c.length>0&&(await re(),oe())}catch(e){console.error("Error loading face models:",e),y("Error loading models")}},[l,s,c.length]),re=n.useCallback(async()=>{try{const e=await Promise.all(c.map(async t=>{const r=t.descriptors.map(i=>new Float32Array(i));return new ye(t.label,r)}));I.current=new ve(e)}catch(e){console.error("Error initializing face matcher:",e)}},[c]),L=n.useCallback(async()=>{var e;try{(e=m.current)!=null&&e.srcObject&&(m.current.srcObject.getTracks().forEach(i=>i.stop()),m.current.srcObject=null);const t=await navigator.mediaDevices.getUserMedia({video:{facingMode:E}});m.current&&(m.current.srcObject=t,m.current.onloadedmetadata=()=>{l||q()})}catch(t){console.error("Error starting video:",t),y("Error accessing camera")}},[E,l,q]),oe=n.useCallback(()=>{if(!I.current||!m.current||!g.current)return;N.current&&clearInterval(N.current);const e=async()=>{try{if(!m.current||!g.current||!I.current)return;const t=await we(m.current,new Se).withFaceLandmarks().withFaceDescriptors().withFaceExpressions(),r=g.current,i={width:500,height:600};Fe(r,i);const d=Q(t,i),h=r.getContext("2d");if(h&&h.clearRect(0,0,i.width,i.height),d.length>0){const p=d.map(R=>I.current.findBestMatch(R.descriptor));Ne(r,d),p.forEach((R,le)=>{const de=d[le].detection.box;new X(de,{label:R.toString()}).draw(r)});const ie=d[0].expressions,J=p[0],H=J&&J.label!=="unknown",V=Ee(ie);H&&V?(k("passed"),M("Liveliness confirmed: Recognized and smiling!")):H&&!V?(k("pending"),M("Please smile to verify liveliness.")):(k("pending"),M("Face not recognized.")),B(p),y("Running")}else k("pending"),M("No face detected"),B([])}catch(t){console.error("Detection error:",t)}};N.current=setInterval(e,500)},[]),S=n.useCallback(async()=>{try{const t=(await K.get("users/userDetails",{headers:{Authorization:`Token ${localStorage.getItem("accessToken")}`}})).data;if(t!=null&&t.description){const r=[{label:t.full_name,descriptors:t.description}],i=[{id:t.full_name,name:t.full_name,position:t.job_title}];u(r),ae(i),f(!0);const d=$(t.location);d&&U(d.latitude,d.longitude)}else console.error("No face description data in API response"),y("No face data available")}catch(e){console.error("Error fetching data:",e),y("Error loading face data")}},[$,U]);n.useEffect(()=>{s&&c.length>0&&L()},[s,c.length,L]),n.useEffect(()=>{s&&L()},[E,s,L]),n.useEffect(()=>{(async()=>{if(navigator.permissions)try{const t=await navigator.permissions.query({name:"geolocation"});t.state==="granted"?S():t.state==="denied"?(b("❌ Location access denied."),w(!1),S()):(b("❓ Location access not determined."),w(null),S())}catch(t){console.error("Permission check error:",t),S()}else b("❓ Location access not supported."),w(null),S()})()},[S]),n.useEffect(()=>()=>{var e;if((e=m.current)!=null&&e.srcObject&&(m.current.srcObject.getTracks().forEach(r=>r.stop()),m.current.srcObject=null),N.current&&clearInterval(N.current),_.current&&cancelAnimationFrame(_.current),g.current){const t=g.current.getContext("2d");t&&t.clearRect(0,0,g.current.width,g.current.height)}y("Stopped")},[]);const ce=()=>{const e=new Date,t=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),i=String(e.getDate()).padStart(2,"0"),d=String(e.getHours()).padStart(2,"0"),h=String(e.getMinutes()).padStart(2,"0"),p=String(e.getSeconds()).padStart(2,"0");return`${t}-${r}-${i}T${d}:${h}:${p}Z`},Y=n.useCallback(e=>{const t=e==="in"?"clocked in":"clocked out",r=ce();K.post("checkinoutregion/create/",{CHECKTIME:r,CHECKTYPE:e==="in"?"I":"o",VERIFYCODE:JSON.parse(localStorage.getItem("user")||"{}").deptid,SENSORID:JSON.parse(localStorage.getItem("user")||"{}").deptid},{headers:{Authorization:`Token ${localStorage.getItem("accessToken")}`}}).then(()=>{C.fire({title:"Success!",text:`You have successfully ${t}!`,icon:"success",confirmButtonColor:"#3085d6"})}).catch(i=>{var d,h;C.fire({icon:"error",title:"Error",text:((h=(d=i.response)==null?void 0:d.data)==null?void 0:h.detail)||"An error occurred while processing your request.",confirmButtonColor:"#d33"})})},[]);return a.jsx("div",{className:"flex-1 h-full overflow-auto",children:a.jsxs("div",{className:"flex-1 items-center mt-20 justify-between",children:[a.jsxs("div",{className:"",children:[a.jsxs("p",{className:"animate-pulse ml-4 text-2xl text-primary",children:["Hello, ",v,"! 👋"]}),a.jsxs("p",{className:"ml-4 text-sm italic text-foreground ",children:["You are currently ",a.jsx("span",{className:" ",children:ee}),T]})]}),a.jsxs("div",{className:"flex flex-col items-center justify-center mt-10 sm:mt-4",children:[a.jsx("p",{className:"text-2xl font-bold sm:text-base text-primary",children:"Digital Biometric"}),a.jsx("p",{className:" text-secondary-foreground text-sm mt-2",children:"Please Smile🙂 To enable the Clock In/Out Button "}),a.jsx("div",{className:"flex w-full justify-center mt-10",children:a.jsx("div",{className:" flex self-center   w-[80%] sm:w-[90%] sm:h-[50vh]  h-[60vh] bg-border border round",children:a.jsxs("div",{className:" border border-border  flex flex-col gap-5 items-center justify-center h-full w-full relative ",children:[a.jsxs("p",{className:" absolute bottom-0 left-0 p-4 justify-start justify-self-start text-secondary-foreground ",children:["Biometric Status:   ",a.jsx("span",{className:A=="Running"?"  justify-end justify-self-end text-green-600":" text-red-500 justify-end justify-self-end",children:A})]}),a.jsx(je,{className:E=="user"?" absolute bottom-0 z-40 cursor-pointer m-5 sm:right-0  justify-end justify-self-end text-foreground rotate-180 transition-all duration-700 col-span-1 ":" absolute bottom-0 sm:right-0 z-40 cursor-pointer m-5  justify-end justify-self-end text-foreground col-span-1  rotate-0 transition-all duration-700",onClick:()=>{se(e=>e==="user"?"environment":"user")}}),a.jsxs("div",{className:" overflow-hidden w-full max-w-[500px] h-[500px] relative flex",children:[a.jsx("div",{className:"w-full absolute top-0 max-w-[500px]",children:a.jsx("div",{className:"text-center my-2",children:a.jsx("span",{className:D==="passed"?"text-green-600":"text-yellow-600",children:te})})}),a.jsx("div",{className:" ml-2 mt-5 absolute gap-2 text-primary col-span-1 flex flex-col ",children:z&&z.map((e,t)=>{const r=ne.find(i=>i.id===e._label);return r?a.jsxs("div",{className:" text-sm bg-card/50 backdrop-blur-md p-2 rounded-md",children:[a.jsx("h3",{children:r.name}),a.jsx("p",{children:r.position})]},t):null})}),a.jsx("video",{crossOrigin:"anonymous",ref:m,className:" w-full h-full  rounded-md ",autoPlay:!0,muted:!0,playsInline:!0}),a.jsx("canvas",{ref:g,className:"  w-full h-full  absolute"})]}),a.jsx("div",{className:" w-[300px]  grid  justify-center items-center  grid-cols-3  "})]})})}),a.jsxs("div",{className:" mt-10 flex gap-6  justify-center",children:[a.jsx(Z,{className:D==="passed"?" bg-primary ":"  pointer-events-none bg-red-500/50  ",onClick:()=>Y("in"),children:"Time In"}),a.jsx(Z,{className:D==="passed"?" bg-primary ":"  pointer-events-none bg-red-500/50  ",onClick:()=>Y("out"),children:"Time Out"})]})]})]})})}export{De as default};
