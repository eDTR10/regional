import{p as ue,X as P,Y as T,Z as fe,_ as me,$ as X,a0 as he,a1 as ge,a2 as pe,a3 as xe,a4 as G,a5 as be,r,S as F,a6 as k,a7 as ye,a8 as we,a as K,j as n,O as Z,a9 as ve,aa as Se}from"./index-0aa3940c.js";const je=ue("RotateCcw",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]]);function Ne(s,f){var l=Array.isArray(f)?f:[f];l.forEach(function(o){var i=o instanceof P?o.score:T(o)?o.detection.score:void 0,u=o instanceof P?o.box:T(o)?o.detection.box:new fe(o),x=i?""+me(i):void 0;new X(u,{label:x}).draw(s)})}function Fe(s,f,l){l===void 0&&(l=!1);var o=l?he(f):f,i=o.width,u=o.height;return s.width=i,s.height=u,{width:i,height:u}}function Q(s,f){var l=new ge(f.width,f.height),o=l.width,i=l.height;if(o<=0||i<=0)throw new Error("resizeResults - invalid dimensions: "+JSON.stringify({width:o,height:i}));if(Array.isArray(s))return s.map(function(w){return Q(w,{width:o,height:i})});if(pe(s)){var u=s.detection.forSize(o,i),x=s.unshiftedLandmarks.forSize(u.box.width,u.box.height);return xe(G(s,u),x)}return T(s)?G(s,s.detection.forSize(o,i)):s instanceof be||s instanceof P?s.forSize(o,i):s}function ke(s,f,l,o){const u=(l-s)*Math.PI/180,x=(o-f)*Math.PI/180,w=Math.sin(u/2)*Math.sin(u/2)+Math.cos(s*Math.PI/180)*Math.cos(l*Math.PI/180)*Math.sin(x/2)*Math.sin(x/2);return 6371*(2*Math.atan2(Math.sqrt(w),Math.sqrt(1-w)))}function Ee(s,f,l,o,i=1.5){const u=ke(s,f,l,o);return{isNearby:u<=i,distance:u}}function Me(s){return s.happy>.7}function De(){var W;const[s,f]=r.useState(!1),[l,o]=r.useState(!1),[i,u]=r.useState([]),w=(W=r.useRef((()=>{const e=localStorage.getItem("user");return e?JSON.parse(e):null})()).current)==null?void 0:W.full_name,[D,v]=r.useState(null),[ee,b]=r.useState(null),[R,E]=r.useState("pending"),[te,M]=r.useState("Please blink or smile to verify liveliness"),[A,y]=r.useState("Loading..."),j="/regional/models",m=r.useRef(null),g=r.useRef(null),[I,se]=r.useState("environment"),[z,B]=r.useState([]),[re,ne]=r.useState([{id:"",name:"",position:""}]),_=r.useRef(),N=r.useRef(),L=r.useRef(null),$=r.useCallback(e=>{if(!e||e.length===0)return null;const[t]=e,[a,c]=t.split(",").map(Number);return{latitude:parseFloat(a.toFixed(6)),longitude:parseFloat(c.toFixed(6))}},[]),U=r.useCallback((e,t)=>{if(!navigator.geolocation){b(null),F.fire({icon:"error",title:"Geolocation Not Supported",text:"Your browser does not support geolocation.",confirmButtonColor:"#3085d6"});return}navigator.geolocation.getCurrentPosition(a=>{const{latitude:c,longitude:d}=a.coords,{isNearby:h,distance:p}=Ee(c,d,e,t);h?(b(`âœ… Within office range! (${p.toFixed(2)} km)`),v("ok")):(b(`âŒ Outside office range (${p.toFixed(2)} km from office)`),v(!1))},a=>{b(null);const d={[a.PERMISSION_DENIED]:"Please enable location access in your browser settings. Or browse to you destop settings and enable location access.",[a.POSITION_UNAVAILABLE]:"Location information is unavailable.",[a.TIMEOUT]:"Location request timed out."}[a.code]||"An unknown error occurred.";F.fire({icon:"error",title:"Location Error",text:d,confirmButtonColor:"#3085d6"})})},[]),Y=r.useCallback(async()=>{if(!l)try{y("Loading models..."),await Promise.all([k.ssdMobilenetv1.loadFromUri(j),k.tinyFaceDetector.loadFromUri(j),k.faceLandmark68Net.loadFromUri(j),k.faceRecognitionNet.loadFromUri(j),k.faceExpressionNet.loadFromUri(j)]),o(!0),console.log("Face models loaded successfully"),s&&i.length>0&&(await ae(),oe())}catch(e){console.error("Error loading face models:",e),y("Error loading models")}},[l,s,i.length]),ae=r.useCallback(async()=>{try{const e=await Promise.all(i.map(async t=>{const a=t.descriptors.map(c=>new Float32Array(c));return new ye(t.label,a)}));L.current=new we(e)}catch(e){console.error("Error initializing face matcher:",e)}},[i]),C=r.useCallback(async()=>{var e;try{(e=m.current)!=null&&e.srcObject&&(m.current.srcObject.getTracks().forEach(c=>c.stop()),m.current.srcObject=null);const t=await navigator.mediaDevices.getUserMedia({video:{facingMode:I}});m.current&&(m.current.srcObject=t,m.current.onloadedmetadata=()=>{l||Y()})}catch(t){console.error("Error starting video:",t),y("Error accessing camera")}},[I,l,Y]),oe=r.useCallback(()=>{if(!L.current||!m.current||!g.current)return;N.current&&clearInterval(N.current);const e=async()=>{try{if(!m.current||!g.current||!L.current)return;const t=await ve(m.current,new Se).withFaceLandmarks().withFaceDescriptors().withFaceExpressions(),a=g.current,c={width:500,height:600};Fe(a,c);const d=Q(t,c),h=a.getContext("2d");if(h&&h.clearRect(0,0,c.width,c.height),d.length>0){const p=d.map(O=>L.current.findBestMatch(O.descriptor));Ne(a,d),p.forEach((O,le)=>{const de=d[le].detection.box;new X(de,{label:O.toString()}).draw(a)});const ce=d[0].expressions,J=p[0],H=J&&J.label!=="unknown",V=Me(ce);H&&V?(E("passed"),M("Liveliness confirmed: Recognized and smiling!")):H&&!V?(E("pending"),M("Please smile to verify liveliness.")):(E("pending"),M("Face not recognized.")),B(p),y("Running")}else E("pending"),M("No face detected"),B([])}catch(t){console.error("Detection error:",t)}};N.current=setInterval(e,500)},[]),S=r.useCallback(async()=>{try{const t=(await K.get("users/userDetails",{headers:{Authorization:`Token ${localStorage.getItem("accessToken")}`}})).data;if(t!=null&&t.description){const a=[{label:t.full_name,descriptors:t.description}],c=[{id:t.full_name,name:t.full_name,position:t.job_title}];u(a),ne(c),f(!0);const d=$(t.location);d&&U(d.latitude,d.longitude)}else console.error("No face description data in API response"),y("No face data available")}catch(e){console.error("Error fetching data:",e),y("Error loading face data")}},[$,U]);r.useEffect(()=>{s&&i.length>0&&C()},[s,i.length,C]),r.useEffect(()=>{s&&C()},[I,s,C]),r.useEffect(()=>{(async()=>{if(navigator.permissions)try{const t=await navigator.permissions.query({name:"geolocation"});t.state==="granted"?S():t.state==="denied"?(b("âŒ Location access denied."),v(!1),S()):(b("â“ Location access not determined."),v(null),S())}catch(t){console.error("Permission check error:",t),S()}else b("â“ Location access not supported."),v(null),S()})()},[S]),r.useEffect(()=>()=>{var e;if((e=m.current)!=null&&e.srcObject&&(m.current.srcObject.getTracks().forEach(a=>a.stop()),m.current.srcObject=null),N.current&&clearInterval(N.current),_.current&&cancelAnimationFrame(_.current),g.current){const t=g.current.getContext("2d");t&&t.clearRect(0,0,g.current.width,g.current.height)}y("Stopped")},[]);const ie=()=>{const e=new Date,t=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),c=String(e.getDate()).padStart(2,"0"),d=String(e.getHours()).padStart(2,"0"),h=String(e.getMinutes()).padStart(2,"0"),p=String(e.getSeconds()).padStart(2,"0");return`${t}-${a}-${c}T${d}:${h}:${p}Z`},q=r.useCallback(e=>{const t=e==="in"?"clocked in":"clocked out",a=ie();D?K.post("checkinoutregion/create/",{CHECKTIME:a,CHECKTYPE:e==="in"?"I":"o",VERIFYCODE:JSON.parse(localStorage.getItem("user")||"{}").deptid,SENSORID:JSON.parse(localStorage.getItem("user")||"{}").deptid},{headers:{Authorization:`Token ${localStorage.getItem("accessToken")}`}}).then(()=>{F.fire({title:"Success!",text:`You have successfully ${t}!`,icon:"success",confirmButtonColor:"#3085d6"})}).catch(c=>{var d,h;F.fire({icon:"error",title:"Error",text:((h=(d=c.response)==null?void 0:d.data)==null?void 0:h.detail)||"An error occurred while processing your request.",confirmButtonColor:"#d33"})}):F.fire({title:"Error",text:"You are not within your designated office!",icon:"error",confirmButtonColor:"#3085d6"})},[]);return n.jsx("div",{className:"flex-1 h-full overflow-auto",children:n.jsxs("div",{className:"flex-1 items-center mt-20 justify-between",children:[n.jsxs("div",{className:"",children:[n.jsxs("p",{className:"animate-pulse ml-4 text-2xl text-primary",children:["Hello, ",w,"! ðŸ‘‹"]}),n.jsxs("p",{className:"ml-4 text-sm italic text-foreground ",children:["You are currently ",n.jsx("span",{className:" ",children:ee}),D]})]}),n.jsxs("div",{className:"flex flex-col items-center justify-center mt-10 sm:mt-4",children:[n.jsx("p",{className:"text-2xl font-bold sm:text-base text-primary",children:"Digital Biometric"}),n.jsxs("p",{className:" text-secondary-foreground text-sm mt-2",children:["Please SmileðŸ™‚ To enable the Clock In/Out Button"," "]}),n.jsx("div",{className:"flex w-full justify-center mt-10",children:n.jsx("div",{className:" flex self-center   w-[80%] sm:w-[90%] sm:h-[50vh]  h-[60vh] bg-border border round",children:n.jsxs("div",{className:" border border-border  flex flex-col gap-5 items-center justify-center h-full w-full relative ",children:[n.jsxs("p",{className:" absolute bottom-0 left-0 p-4 justify-start justify-self-start text-secondary-foreground ",children:["Biometric Status: Â ",n.jsx("span",{className:A=="Running"?"  justify-end justify-self-end text-green-600":" text-red-500 justify-end justify-self-end",children:A})]}),n.jsx(je,{className:I=="user"?" absolute bottom-0 z-40 cursor-pointer m-5 sm:right-0  justify-end justify-self-end text-foreground rotate-180 transition-all duration-700 col-span-1 ":" absolute bottom-0 sm:right-0 z-40 cursor-pointer m-5  justify-end justify-self-end text-foreground col-span-1  rotate-0 transition-all duration-700",onClick:()=>{se(e=>e==="user"?"environment":"user")}}),n.jsxs("div",{className:" overflow-hidden w-full max-w-[500px] h-[500px] relative flex",children:[n.jsx("div",{className:"w-full absolute top-0 max-w-[500px]",children:n.jsx("div",{className:"text-center my-2",children:n.jsx("span",{className:R==="passed"?"text-green-600":"text-yellow-600",children:te})})}),n.jsx("div",{className:" ml-2 mt-5 absolute gap-2 text-primary col-span-1 flex flex-col ",children:z&&z.map((e,t)=>{const a=re.find(c=>c.id===e._label);return a?n.jsxs("div",{className:" text-sm bg-card/50 backdrop-blur-md p-2 rounded-md",children:[n.jsx("h3",{children:a.name}),n.jsx("p",{children:a.position})]},t):null})}),n.jsx("video",{crossOrigin:"anonymous",ref:m,className:" w-full h-full  rounded-md ",autoPlay:!0,muted:!0,playsInline:!0}),n.jsx("canvas",{ref:g,className:"  w-full h-full  absolute"})]}),n.jsx("div",{className:" w-[300px]  grid  justify-center items-center  grid-cols-3  "})]})})}),n.jsxs("div",{className:" mt-10 flex gap-6  justify-center",children:[n.jsx(Z,{className:R==="passed"?" bg-primary ":"  pointer-events-none bg-red-500/50  ",onClick:()=>q("in"),children:"Time In"}),n.jsx(Z,{className:R==="passed"?" bg-primary ":"  pointer-events-none bg-red-500/50  ",onClick:()=>q("out"),children:"Time Out"})]})]})]})})}export{De as default};
