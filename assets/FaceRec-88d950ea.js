import{p as ue,X as T,Y as z,Z as fe,_ as me,$ as Q,a0 as he,a1 as ge,a2 as pe,a3 as xe,a4 as K,a5 as ye,r as n,a6 as E,a7 as we,a8 as ve,a as Z,S as A,j as a,O as X,a9 as be,aa as Se}from"./index-464101f3.js";const je=ue("RotateCcw",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]]);function Ne(s,f){var l=Array.isArray(f)?f:[f];l.forEach(function(o){var c=o instanceof T?o.score:z(o)?o.detection.score:void 0,d=o instanceof T?o.box:z(o)?o.detection.box:new fe(o),g=c?""+me(c):void 0;new Q(d,{label:g}).draw(s)})}function ke(s,f,l){l===void 0&&(l=!1);var o=l?he(f):f,c=o.width,d=o.height;return s.width=c,s.height=d,{width:c,height:d}}function ee(s,f){var l=new ge(f.width,f.height),o=l.width,c=l.height;if(o<=0||c<=0)throw new Error("resizeResults - invalid dimensions: "+JSON.stringify({width:o,height:c}));if(Array.isArray(s))return s.map(function(x){return ee(x,{width:o,height:c})});if(pe(s)){var d=s.detection.forSize(o,c),g=s.unshiftedLandmarks.forSize(d.box.width,d.box.height);return xe(K(s,d),g)}return z(s)?K(s,s.detection.forSize(o,c)):s instanceof ye||s instanceof T?s.forSize(o,c):s}function Fe(s,f,l,o){const d=(l-s)*Math.PI/180,g=(o-f)*Math.PI/180,x=Math.sin(d/2)*Math.sin(d/2)+Math.cos(s*Math.PI/180)*Math.cos(l*Math.PI/180)*Math.sin(g/2)*Math.sin(g/2);return 6371*(2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x)))}function Ie(s){return s.happy>.7}function Ee(s,f,l,o=.15){let c=1/0,d=!1,g="";return l.forEach(x=>{const[b,h]=x.split(",").map(y=>parseFloat(y.trim())),N=Fe(s,f,b,h);N<=o&&(d=!0),N<c&&(c=N,g=x)}),{isNearby:d,distance:c,nearestLocation:g}}function De(){var H;const[s,f]=n.useState(!1),[l,o]=n.useState(!1),[c,d]=n.useState([]),x=(H=n.useRef((()=>{const e=localStorage.getItem("user");return e?JSON.parse(e):null})()).current)==null?void 0:H.full_name,[b,h]=n.useState(null),[N,y]=n.useState(null),[M,L]=n.useState("pending"),[te,R]=n.useState("Please blink or smile to verify liveliness"),[B,S]=n.useState("Loading..."),k="/regional/models",m=n.useRef(null),w=n.useRef(null),[D,se]=n.useState("user"),[_,$]=n.useState([]),[re,ne]=n.useState([{id:"",name:"",position:""}]),U=n.useRef(),F=n.useRef(),C=n.useRef(null),I=n.useRef(),q=n.useCallback(e=>{const r=()=>{if(console.log("Checking location..."),!navigator.geolocation){y(null),h("error"),A.fire({icon:"error",title:"Geolocation Not Supported",text:"Your browser does not support geolocation.",confirmButtonColor:"#3085d6"});return}navigator.geolocation.getCurrentPosition(t=>{const{latitude:i,longitude:u}=t.coords,{isNearby:p,distance:v}=Ee(i,u,e);y(p?`✅ Within office range! (${v.toFixed(2)} km)`:`❌ Outside office range (${v.toFixed(2)} km from nearest office)`),h(p?"ok":"error")},t=>{y(null),h("error");const u={[t.PERMISSION_DENIED]:"Please enable location access in your browser settings. Or browse to you destop settings and enable location access.",[t.POSITION_UNAVAILABLE]:"Location information is unavailable.",[t.TIMEOUT]:"Location request timed out."}[t.code]||"An unknown error occurred.";A.fire({icon:"error",title:"Location Error",text:u,confirmButtonColor:"#3085d6"})},{enableHighAccuracy:!0,timeout:5e3,maximumAge:0})};I.current&&clearInterval(I.current),r(),I.current=setInterval(r,1e4)},[]),Y=n.useCallback(async()=>{if(!l)try{S("Loading models..."),await Promise.all([E.ssdMobilenetv1.loadFromUri(k),E.tinyFaceDetector.loadFromUri(k),E.faceLandmark68Net.loadFromUri(k),E.faceRecognitionNet.loadFromUri(k),E.faceExpressionNet.loadFromUri(k)]),o(!0),console.log("Face models loaded successfully"),s&&c.length>0&&(await ae(),oe())}catch(e){console.error("Error loading face models:",e),S("Error loading models")}},[l,s,c.length]),ae=n.useCallback(async()=>{try{const e=await Promise.all(c.map(async r=>{const t=r.descriptors.map(i=>new Float32Array(i));return new we(r.label,t)}));C.current=new ve(e)}catch(e){console.error("Error initializing face matcher:",e)}},[c]),O=n.useCallback(async()=>{var e;try{(e=m.current)!=null&&e.srcObject&&(m.current.srcObject.getTracks().forEach(i=>i.stop()),m.current.srcObject=null);const r=await navigator.mediaDevices.getUserMedia({video:{facingMode:D}});m.current&&(m.current.srcObject=r,m.current.onloadedmetadata=()=>{l||Y()})}catch(r){console.error("Error starting video:",r),S("Error accessing camera")}},[D,l,Y]),oe=n.useCallback(()=>{if(!C.current||!m.current||!w.current)return;F.current&&clearInterval(F.current);const e=async()=>{try{if(!m.current||!w.current||!C.current)return;const r=await be(m.current,new Se).withFaceLandmarks().withFaceDescriptors().withFaceExpressions(),t=w.current,i={width:500,height:600};ke(t,i);const u=ee(r,i),p=w.current.getContext("2d",{willReadFrequently:!0});if(p&&p.clearRect(0,0,i.width,i.height),u.length>0){const v=u.map(P=>C.current.findBestMatch(P.descriptor));Ne(t,u),v.forEach((P,le)=>{const de=u[le].detection.box;new Q(de,{label:P.toString()}).draw(t)});const ie=u[0].expressions,J=v[0],V=J&&J.label!=="unknown",G=Ie(ie);V&&G?(L("passed"),R("Nice Smile!😉")):V&&!G?(L("pending"),R("Please smile.")):(L("pending"),R("Face not recognized.")),$(v),S("Running")}else L("pending"),R("No face detected"),$([])}catch(r){console.error("Detection error:",r)}};F.current=setInterval(e,200)},[]),j=n.useCallback(async()=>{var e;try{const t=(await Z.get("users/userDetails",{headers:{Authorization:`Token ${localStorage.getItem("accessToken")}`}})).data;if(!(t!=null&&t.description))throw new Error("No face description data in API response");const i=[{label:t.full_name,descriptors:t.description}],u=[{id:t.full_name,name:t.full_name,position:t.job_title}];d(i),ne(u),f(!0),((e=t.location)==null?void 0:e.length)>0?q(t.location):(y("❌ No office locations configured"),h("error"))}catch(r){console.error("Error fetching data:",r),S(r.message||"Error loading face data"),h("error")}},[q]);n.useEffect(()=>{s&&c.length>0&&O()},[s,c.length,O]),n.useEffect(()=>{s&&O()},[D,s,O]),n.useEffect(()=>{(async()=>{if(navigator.permissions)try{const r=await navigator.permissions.query({name:"geolocation"});r.state==="granted"?(j(),h("ok")):r.state==="denied"?(y("❌ Location access denied."),h("error"),j()):(y("❓ Location access not determined."),h(null),j())}catch(r){console.error("Permission check error:",r),j()}else y("❓ Location access not supported."),h(null),j()})()},[j]),n.useEffect(()=>()=>{var e;if((e=m.current)!=null&&e.srcObject&&(m.current.srcObject.getTracks().forEach(t=>t.stop()),m.current.srcObject=null),F.current&&clearInterval(F.current),I.current&&clearInterval(I.current),U.current&&cancelAnimationFrame(U.current),w.current){const r=w.current.getContext("2d",{willReadFrequently:!0});r&&r.clearRect(0,0,w.current.width,w.current.height)}S("Stopped"),window.location.reload()},[]);const ce=()=>{const e=new Date,r=e.getFullYear(),t=String(e.getMonth()+1).padStart(2,"0"),i=String(e.getDate()).padStart(2,"0"),u=String(e.getHours()).padStart(2,"0"),p=String(e.getMinutes()).padStart(2,"0"),v=String(e.getSeconds()).padStart(2,"0");return`${r}-${t}-${i}T${u}:${p}:${v}Z`},W=n.useCallback(e=>{const r=e==="in"?"clocked in":"clocked out",t=ce();Z.post("checkinoutregion/create/",{CHECKTIME:t,CHECKTYPE:e==="in"?"I":"o",VERIFYCODE:JSON.parse(localStorage.getItem("user")||"{}").deptid,SENSORID:JSON.parse(localStorage.getItem("user")||"{}").deptid},{headers:{Authorization:`Token ${localStorage.getItem("accessToken")}`}}).then(()=>{A.fire({title:"Success!",text:`You have successfully ${r}!`,icon:"success",confirmButtonColor:"#3085d6"})}).catch(i=>{var u,p;A.fire({icon:"error",title:"Error",text:((p=(u=i.response)==null?void 0:u.data)==null?void 0:p.detail)||"An error occurred while processing your request.",confirmButtonColor:"#d33"})})},[]);return a.jsx("div",{className:"flex-1 h-full overflow-auto",children:a.jsxs("div",{className:"flex-1 items-center mt-20 justify-between",children:[a.jsxs("div",{className:"",children:[a.jsxs("p",{className:"animate-pulse ml-4 text-2xl text-primary",children:["Hello, ",x,"! 👋"]}),a.jsxs("p",{className:"ml-4 text-sm italic text-foreground ",children:["You are currently"," ",a.jsx("span",{className:" ",children:N})]})]}),a.jsxs("div",{className:"flex flex-col items-center justify-center mt-10 sm:mt-4",children:[a.jsx("p",{className:"text-2xl font-bold sm:text-base text-primary",children:"Digital Biometric"}),a.jsxs("p",{className:" text-secondary-foreground text-sm mt-2",children:["Please Smile🙂 To enable the Clock In/Out Button"," "]}),a.jsx("div",{className:"flex w-full justify-center mt-10",children:a.jsx("div",{className:M==="passed"&&b==="ok"?" flex self-center   w-[80%] sm:w-[90%] sm:h-[40vh]  h-[50vh] bg-border border border-5 border-green-500 rounded-md ":" flex self-center   w-[80%] sm:w-[90%] sm:h-[40vh]  h-[50vh] bg-border border rounded-md ",children:a.jsxs("div",{className:"   flex flex-col gap-5 items-center justify-center h-full w-full relative ",children:[a.jsxs("div",{className:" overflow-hidden w-full max-w-[500px] h-[500px] relative flex",children:[a.jsx("div",{className:" ml-2 mt-5 absolute gap-2 text-primary col-span-1 flex flex-col ",children:_&&_.map((e,r)=>{const t=re.find(i=>i.id===e._label);return a.jsxs("div",{className:" text-sm bg-card/50 backdrop-blur-md p-2 rounded-md",children:[a.jsx("h3",{children:t?t.name:"Unknown"}),a.jsx("p",{children:t?t.position:"Unrecognized Person"})]},r)})}),a.jsx("video",{crossOrigin:"anonymous",ref:m,className:" w-full h-full  rounded-md ",autoPlay:!0,muted:!0,playsInline:!0}),a.jsx("canvas",{ref:w,className:"  w-full h-full  absolute"})]}),a.jsx("div",{className:" w-[300px]  grid  justify-center items-center  grid-cols-3  "})]})})}),a.jsxs("div",{className:" relative  grid grid-cols-3 justify-center  w-[80%] items-center   h-full",children:[a.jsxs("p",{className:" relative bottom-0 left-0 p-4 z-[999] justify-start justify-self-start  sm:text-sm  text-secondary-foreground ",children:["Status:  ",a.jsx("span",{className:B=="Running"?"  justify-end justify-self-end z-[999] text-green-600":" text-red-500 justify-end z-[999] justify-self-end",children:B})]}),a.jsx(je,{className:D=="user"?"   cursor-pointer m-5 text-foreground justify-center self-center justify-self-center rotate-180 transition-all duration-700 col-span-1 ":" justify-center self-center justify-self-center cursor-pointer m-5 text-foreground col-span-1  rotate-0 transition-all duration-700",onClick:()=>{se(e=>e==="user"?"environment":"user")}}),a.jsx("span",{className:M==="passed"?"text-green-600 sm:text-sm justify-self-end":"text-yellow-600 sm:text-sm  justify-self-end",children:te})]}),a.jsxs("div",{className:" mt-10 flex gap-6  justify-center",children:[a.jsx(X,{className:M==="passed"&&b==="ok"?" bg-primary ":"  pointer-events-none bg-red-500/50  ",onClick:()=>W("in"),children:"Time In"}),a.jsx(X,{className:M==="passed"&&b==="ok"?" bg-primary ":"  pointer-events-none bg-red-500/50  ",onClick:()=>W("out"),children:"Time Out"})]})]})]})})}export{De as default};
